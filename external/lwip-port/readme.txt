This is basically the port from STM32Cube butchered a bit